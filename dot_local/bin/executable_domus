#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────────────────────
# domus - Unified home directory management CLI
# Domus Semper Palingenesis: The ever-regenerating home
# ─────────────────────────────────────────────────────────────────────────────
#
# Usage:
#   domus                    # Status summary
#   domus status [--json]    # Full status report
#   domus apply [--dry-run]  # Sync all (dotfiles + packages)
#   domus sort [--watch]     # Run file sorter
#   domus packages [diff|apply]  # Package management
#   domus perf [shell]       # Performance report
#   domus health             # Health check (wraps chezmoi-health)
#
# Exit codes:
#   0 - Success
#   1 - Issues detected (drift, warnings)
#   2 - Error

set -euo pipefail

# ─────────────────────────────────────────────────────────────────────────────
# Configuration
# ─────────────────────────────────────────────────────────────────────────────

DOMUS_VERSION="1.0.0"
CONFIG_DIR="${HOME}/.config/domus"
STATE_DIR="${HOME}/.local/state/domus"
MANIFEST="${CONFIG_DIR}/manifest.yaml"
BIN_DIR="${HOME}/.local/bin"

# ─────────────────────────────────────────────────────────────────────────────
# Colors (disabled for non-interactive or piped output)
# ─────────────────────────────────────────────────────────────────────────────

if [[ -t 1 ]]; then
  RED=$'\033[0;31m'
  GREEN=$'\033[0;32m'
  YELLOW=$'\033[0;33m'
  BLUE=$'\033[0;34m'
  CYAN=$'\033[0;36m'
  DIM=$'\033[0;90m'
  BOLD=$'\033[1m'
  RESET=$'\033[0m'
else
  RED='' GREEN='' YELLOW='' BLUE='' CYAN='' DIM='' BOLD='' RESET=''
fi

# ─────────────────────────────────────────────────────────────────────────────
# Helpers
# ─────────────────────────────────────────────────────────────────────────────

die() {
  printf '%serror:%s %s\n' "$RED" "$RESET" "$1" >&2
  exit 2
}

info() {
  printf '%s::%s %s\n' "$BLUE" "$RESET" "$1"
}

success() {
  printf '%s✓%s %s\n' "$GREEN" "$RESET" "$1"
}

warn() {
  printf '%s!%s %s\n' "$YELLOW" "$RESET" "$1"
}

check_deps() {
  local missing=()
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      missing+=("$cmd")
    fi
  done
  if [[ ${#missing[@]} -gt 0 ]]; then
    die "Missing dependencies: ${missing[*]}"
  fi
}

check_manifest() {
  if [[ ! -f "${MANIFEST}" ]]; then
    die "Manifest not found: ${MANIFEST}"
  fi
}

# ─────────────────────────────────────────────────────────────────────────────
# YAML Parser (minimal, bash-only)
# ─────────────────────────────────────────────────────────────────────────────

# Parse simple YAML value (uses yq if available, falls back to grep/sed)
yaml_get() {
  local file="$1"
  local key="$2"

  if command -v yq &>/dev/null; then
    yq -r "$key" "$file" 2>/dev/null || echo ""
  else
    # Fallback: very basic parsing for simple keys
    grep -E "^${key}:" "$file" 2>/dev/null | sed 's/^[^:]*: *//' | tr -d '"' || echo ""
  fi
}

# ─────────────────────────────────────────────────────────────────────────────
# Commands
# ─────────────────────────────────────────────────────────────────────────────

cmd_version() {
  echo "domus ${DOMUS_VERSION}"
}

cmd_help() {
  cat <<EOF
${BOLD}domus${RESET} - Unified home directory management
${DIM}Domus Semper Palingenesis: The ever-regenerating home${RESET}

${BOLD}USAGE${RESET}
    domus [COMMAND] [OPTIONS]

${BOLD}COMMANDS${RESET}
    ${CYAN}status${RESET}              Status summary (default)
        --json          Machine-readable output

    ${CYAN}apply${RESET}               Sync all (dotfiles + packages)
        --dry-run       Preview changes only
        --dotfiles      Only sync dotfiles (chezmoi)
        --packages      Only sync packages

    ${CYAN}sort${RESET}                Run file sorter once
        --watch         Start FSEvents daemon

    ${CYAN}packages${RESET}            Package status
        diff            Show drift from manifest
        apply           Install missing packages
        --json          Machine-readable output

    ${CYAN}perf${RESET}                Performance report
        shell           Shell startup trend
        daemon          Daemon run times
        --json          Machine-readable output

    ${CYAN}health${RESET}              Chezmoi health check
        --json          Machine-readable output

    ${CYAN}doctor${RESET}              Comprehensive system diagnostics

${BOLD}OPTIONS${RESET}
    -h, --help          Show this help
    -v, --version       Show version

${BOLD}EXAMPLES${RESET}
    domus                   # Quick status
    domus apply --dry-run   # Preview sync
    domus packages diff     # Show package drift
    domus perf shell        # Shell startup times

EOF
}

cmd_status() {
  local json_mode=0
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --json)
        json_mode=1
        shift
        ;;
      *) shift ;;
    esac
  done

  if [[ $json_mode -eq 1 ]]; then
    cmd_status_json
    return
  fi

  echo ""
  printf '%sDomus Status%s %s%s%s\n' "$BOLD" "$RESET" "$DIM" "$(date '+%Y-%m-%d %H:%M')" "$RESET"
  echo ""

  local exit_code=0

  # Chezmoi status
  printf '%s[dotfiles]%s ' "$CYAN" "$RESET"
  if command -v chezmoi &>/dev/null; then
    local drift
    drift=$(chezmoi diff 2>/dev/null | head -1) || drift=""
    if [[ -z "$drift" ]]; then
      printf '%s✓%s synced\n' "$GREEN" "$RESET"
    else
      printf '%s!%s drift detected\n' "$YELLOW" "$RESET"
      exit_code=1
    fi
  else
    printf '%s○%s chezmoi not found\n' "$DIM" "$RESET"
  fi

  # Package status
  printf '%s[packages]%s ' "$CYAN" "$RESET"
  if [[ -x "${BIN_DIR}/domus-packages" ]]; then
    local pkg_status
    pkg_status=$("${BIN_DIR}/domus-packages" status --quiet 2>/dev/null || true)
    case "$pkg_status" in
      synced) printf '%s✓%s synced\n' "$GREEN" "$RESET" ;;
      drift)
        printf '%s!%s drift detected\n' "$YELLOW" "$RESET"
        exit_code=1
        ;;
      *) printf '%s○%s unknown\n' "$DIM" "$RESET" ;;
    esac
  else
    printf '%s○%s not configured\n' "$DIM" "$RESET"
  fi

  # Sort status
  printf '%s[sorting]%s  ' "$CYAN" "$RESET"
  if pgrep -qf "domus-sort.*--watch" 2>/dev/null; then
    printf '%s✓%s watching\n' "$GREEN" "$RESET"
  else
    printf '%s○%s idle\n' "$DIM" "$RESET"
  fi

  # Shell startup
  printf '%s[shell]%s    ' "$CYAN" "$RESET"
  local telemetry="${STATE_DIR}/telemetry/shell-startup.jsonl"
  if [[ -f "$telemetry" ]]; then
    local last_ms
    last_ms=$(tail -1 "$telemetry" 2>/dev/null | grep -o '"ms":[0-9]*' | grep -o '[0-9]*') || last_ms=""
    if [[ -n "$last_ms" ]]; then
      local target_ms=200
      local warning_ms=500
      if command -v yq &>/dev/null && [[ -f "${MANIFEST}" ]]; then
        target_ms=$(yq -r '.performance.shell_startup.target_ms // 200' "${MANIFEST}")
        warning_ms=$(yq -r '.performance.shell_startup.warning_ms // 500' "${MANIFEST}")
      fi

      if [[ $last_ms -le $target_ms ]]; then
        printf '%s✓%s %sms (target: %sms)\n' "$GREEN" "$RESET" "$last_ms" "$target_ms"
      elif [[ $last_ms -le $warning_ms ]]; then
        printf '%s!%s %sms (target: %sms)\n' "$YELLOW" "$RESET" "$last_ms" "$target_ms"
      else
        printf '%s✗%s %sms (target: %sms)\n' "$RED" "$RESET" "$last_ms" "$target_ms"
        exit_code=1
      fi
    else
      printf '%s○%s no data\n' "$DIM" "$RESET"
    fi
  else
    printf '%s○%s not tracked\n' "$DIM" "$RESET"
  fi

  echo ""

  if [[ $exit_code -eq 0 ]]; then
    printf '%s%sAll systems healthy%s\n' "$GREEN" "$BOLD" "$RESET"
  else
    printf '%s%sIssues detected%s - run '\''domus apply'\'' to sync\n' "$YELLOW" "$BOLD" "$RESET"
  fi
  echo ""

  return $exit_code
}

cmd_status_json() {
  local dotfiles_status="unknown"
  local packages_status="unknown"
  local sort_status="idle"
  local shell_ms="null"

  if command -v chezmoi &>/dev/null; then
    if chezmoi diff 2>/dev/null | head -1 | grep -q .; then
      dotfiles_status="drift"
    else
      dotfiles_status="synced"
    fi
  fi

  if [[ -x "${BIN_DIR}/domus-packages" ]]; then
    packages_status=$("${BIN_DIR}/domus-packages" status --quiet 2>/dev/null) || packages_status="error"
  fi

  if pgrep -qf "domus-sort.*--watch" 2>/dev/null; then
    sort_status="watching"
  fi

  local telemetry="${STATE_DIR}/telemetry/shell-startup.jsonl"
  if [[ -f "$telemetry" ]]; then
    shell_ms=$(tail -1 "$telemetry" 2>/dev/null | grep -o '"ms":[0-9]*' | grep -o '[0-9]*') || shell_ms="null"
  fi

  cat <<EOF
{
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "dotfiles": "${dotfiles_status}",
  "packages": "${packages_status}",
  "sorting": "${sort_status}",
  "shell_startup_ms": ${shell_ms}
}
EOF
}

cmd_apply() {
  local dry_run=0
  local dotfiles_only=0
  local packages_only=0

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        dry_run=1
        shift
        ;;
      --dotfiles)
        dotfiles_only=1
        shift
        ;;
      --packages)
        packages_only=1
        shift
        ;;
      *) shift ;;
    esac
  done

  local exit_code=0

  # Apply dotfiles
  if [[ $packages_only -eq 0 ]]; then
    info "Syncing dotfiles..."
    if [[ $dry_run -eq 1 ]]; then
      chezmoi diff 2>/dev/null || true
    else
      if chezmoi apply 2>/dev/null; then
        success "Dotfiles synced"
      else
        warn "Dotfiles sync had issues"
        exit_code=1
      fi
    fi
  fi

  # Apply packages
  if [[ $dotfiles_only -eq 0 ]]; then
    info "Syncing packages..."
    if [[ -x "${BIN_DIR}/domus-packages" ]]; then
      if [[ $dry_run -eq 1 ]]; then
        "${BIN_DIR}/domus-packages" diff
      else
        if "${BIN_DIR}/domus-packages" apply; then
          success "Packages synced"
        else
          warn "Package sync had issues"
          exit_code=1
        fi
      fi
    else
      warn "domus-packages not found, skipping"
    fi
  fi

  return $exit_code
}

cmd_sort() {
  local watch_mode=0

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --watch)
        watch_mode=1
        shift
        ;;
      *) shift ;;
    esac
  done

  if [[ ! -x "${BIN_DIR}/domus-sort" ]]; then
    die "domus-sort not found"
  fi

  if [[ $watch_mode -eq 1 ]]; then
    exec "${BIN_DIR}/domus-sort" --watch
  else
    exec "${BIN_DIR}/domus-sort"
  fi
}

cmd_packages() {
  local subcmd="${1:-}"
  shift 2>/dev/null || true

  if [[ ! -x "${BIN_DIR}/domus-packages" ]]; then
    die "domus-packages not found"
  fi

  case "$subcmd" in
    diff | apply | status)
      exec "${BIN_DIR}/domus-packages" "$subcmd" "$@"
      ;;
    "" | --json)
      exec "${BIN_DIR}/domus-packages" status "$subcmd" "$@"
      ;;
    *)
      exec "${BIN_DIR}/domus-packages" "$subcmd" "$@"
      ;;
  esac
}

cmd_perf() {
  local subcmd="${1:-}"
  shift 2>/dev/null || true
  local json_mode=0

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --json)
        json_mode=1
        shift
        ;;
      *) shift ;;
    esac
  done

  case "$subcmd" in
    shell)
      cmd_perf_shell "$json_mode"
      ;;
    daemon)
      cmd_perf_daemon "$json_mode"
      ;;
    *)
      cmd_perf_summary "$json_mode"
      ;;
  esac
}

cmd_perf_shell() {
  local json_mode="$1"
  local telemetry="${STATE_DIR}/telemetry/shell-startup.jsonl"

  if [[ ! -f "$telemetry" ]]; then
    if [[ $json_mode -eq 1 ]]; then
      echo '{"error": "no data"}'
    else
      warn "No shell startup data found"
    fi
    return 1
  fi

  if [[ $json_mode -eq 1 ]]; then
    # Return last 10 entries as JSON array
    echo "["
    tail -10 "$telemetry" | while read -r line; do
      echo "  $line,"
    done | sed '$ s/,$//'
    echo "]"
    return
  fi

  echo ""
  printf '%sShell Startup Times%s %s(last 10)%s\n' "$BOLD" "$RESET" "$DIM" "$RESET"
  echo ""

  local target_ms=200
  local warning_ms=500
  if command -v yq &>/dev/null && [[ -f "${MANIFEST}" ]]; then
    target_ms=$(yq -r '.performance.shell_startup.target_ms // 200' "${MANIFEST}")
    warning_ms=$(yq -r '.performance.shell_startup.warning_ms // 500' "${MANIFEST}")
  fi

  tail -10 "$telemetry" | while read -r line; do
    local ts ms
    ts=$(echo "$line" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4)
    ms=$(echo "$line" | grep -o '"ms":[0-9]*' | grep -o '[0-9]*')

    local color="$GREEN"
    [[ $ms -gt $target_ms ]] && color="$YELLOW"
    [[ $ms -gt $warning_ms ]] && color="$RED"

    printf '  %s%s%s  %s%4dms%s\n' "$DIM" "$ts" "$RESET" "$color" "$ms" "$RESET"
  done

  echo ""
  printf '  Target: %s≤%sms%s  Warning: %s>%sms%s  Critical: %s>%sms%s\n' "$GREEN" "$target_ms" "$RESET" "$YELLOW" "$target_ms" "$RESET" "$RED" "$warning_ms" "$RESET"
  echo ""
}

cmd_perf_daemon() {
  local json_mode="$1"
  local telemetry="${STATE_DIR}/telemetry/daemon-runs.jsonl"

  if [[ ! -f "$telemetry" ]]; then
    if [[ $json_mode -eq 1 ]]; then
      echo '{"error": "no data"}'
    else
      warn "No daemon run data found"
    fi
    return 1
  fi

  if [[ $json_mode -eq 1 ]]; then
    echo "["
    tail -10 "$telemetry" | while read -r line; do
      echo "  $line,"
    done | sed '$ s/,$//'
    echo "]"
    return
  fi

  echo ""
  printf '%sDaemon Run Times%s %s(last 10)%s\n' "$BOLD" "$RESET" "$DIM" "$RESET"
  echo ""

  tail -10 "$telemetry" | while read -r line; do
    local ts ms
    ts=$(echo "$line" | grep -o '"timestamp":"[^"]*"' | cut -d'"' -f4)
    ms=$(echo "$line" | grep -o '"ms":[0-9]*' | grep -o '[0-9]*')
    printf '  %s%s%s  %dms\n' "$DIM" "$ts" "$RESET" "$ms"
  done
  echo ""
}

cmd_perf_summary() {
  local json_mode="$1"

  if [[ $json_mode -eq 1 ]]; then
    local shell_avg=0
    local daemon_avg=0
    local shell_telemetry="${STATE_DIR}/telemetry/shell-startup.jsonl"
    local daemon_telemetry="${STATE_DIR}/telemetry/daemon-runs.jsonl"

    if [[ -f "$shell_telemetry" ]]; then
      shell_avg=$(tail -10 "$shell_telemetry" | grep -o '"ms":[0-9]*' | grep -o '[0-9]*' | awk '{s+=$1; n++} END {print int(s/n)}')
    fi
    if [[ -f "$daemon_telemetry" ]]; then
      daemon_avg=$(tail -10 "$daemon_telemetry" | grep -o '"ms":[0-9]*' | grep -o '[0-9]*' | awk '{s+=$1; n++} END {print int(s/n)}')
    fi

    cat <<EOF
{
  "shell_startup_avg_ms": ${shell_avg:-0},
  "daemon_run_avg_ms": ${daemon_avg:-0}
}
EOF
    return
  fi

  echo ""
  printf '%sPerformance Summary%s\n' "$BOLD" "$RESET"
  echo ""

  cmd_perf_shell 0
  cmd_perf_daemon 0
}

cmd_health() {
  if [[ -x "${BIN_DIR}/chezmoi-health" ]]; then
    exec "${BIN_DIR}/chezmoi-health" "$@"
  else
    die "chezmoi-health not found"
  fi
}

cmd_doctor() {
  local exit_code=0

  echo ""
  printf '%sDomus Doctor%s %s%s%s\n' "$BOLD" "$RESET" "$DIM" "$(date '+%Y-%m-%d %H:%M')" "$RESET"
  echo ""

  # 1. Shell startup time trend
  printf '%s[startup]%s  ' "$CYAN" "$RESET"
  local telemetry="${STATE_DIR}/telemetry/shell-startup.jsonl"
  if [[ -f "$telemetry" ]]; then
    local avg_ms
    avg_ms=$(tail -10 "$telemetry" | grep -o '"ms":[0-9]*' | grep -o '[0-9]*' | awk '{s+=$1; n++} END {if(n>0) print int(s/n); else print 0}')
    if [[ $avg_ms -le 200 ]]; then
      printf '%s✓%s avg %sms (last 10)\n' "$GREEN" "$RESET" "$avg_ms"
    elif [[ $avg_ms -le 500 ]]; then
      printf '%s!%s avg %sms (last 10) - above 200ms target\n' "$YELLOW" "$RESET" "$avg_ms"
    else
      printf '%s✗%s avg %sms (last 10) - above 500ms warning\n' "$RED" "$RESET" "$avg_ms"
      exit_code=1
    fi
  else
    printf '%s○%s no telemetry data\n' "$DIM" "$RESET"
  fi

  # 2. Package drift
  printf '%s[packages]%s ' "$CYAN" "$RESET"
  if [[ -x "${BIN_DIR}/domus-packages" ]]; then
    local pkg_status
    pkg_status=$("${BIN_DIR}/domus-packages" status --quiet 2>/dev/null || echo "unknown")
    case "$pkg_status" in
      synced) printf '%s✓%s in sync with manifest\n' "$GREEN" "$RESET" ;;
      drift)
        printf '%s!%s drift detected\n' "$YELLOW" "$RESET"
        exit_code=1
        ;;
      *) printf '%s○%s unable to check\n' "$DIM" "$RESET" ;;
    esac
  else
    printf '%s○%s domus-packages not available\n' "$DIM" "$RESET"
  fi

  # 3. LaunchAgent status
  printf '%s[daemons]%s  ' "$CYAN" "$RESET"
  if [[ "$(uname)" == "Darwin" ]]; then
    local agents_ok=0
    local agents_missing=0
    for label in com.chezmoi.self-heal com.domus.daemon com.domus.sort; do
      if launchctl list "$label" &>/dev/null; then
        agents_ok=$((agents_ok + 1))
      else
        agents_missing=$((agents_missing + 1))
      fi
    done
    if [[ $agents_missing -eq 0 ]]; then
      printf '%s✓%s %s/3 agents loaded\n' "$GREEN" "$RESET" "$agents_ok"
    else
      printf '%s!%s %s/3 agents loaded (%s missing)\n' "$YELLOW" "$RESET" "$agents_ok" "$agents_missing"
      exit_code=1
    fi
  else
    printf '%s○%s not macOS\n' "$DIM" "$RESET"
  fi

  # 4. Disk space
  printf '%s[disk]%s     ' "$CYAN" "$RESET"
  local disk_pct
  disk_pct=$(df -h / | awk 'NR==2 {gsub(/%/,"",$5); print $5}')
  if [[ $disk_pct -lt 80 ]]; then
    printf '%s✓%s %s%% used\n' "$GREEN" "$RESET" "$disk_pct"
  elif [[ $disk_pct -lt 90 ]]; then
    printf '%s!%s %s%% used\n' "$YELLOW" "$RESET" "$disk_pct"
  else
    printf '%s✗%s %s%% used - disk nearly full\n' "$RED" "$RESET" "$disk_pct"
    exit_code=1
  fi

  # 5. 1Password CLI
  printf '%s[1password]%s' "$CYAN" "$RESET"
  if command -v op &>/dev/null; then
    if op whoami &>/dev/null 2>&1; then
      printf ' %s✓%s authenticated\n' "$GREEN" "$RESET"
    else
      printf ' %s!%s installed but not signed in\n' "$YELLOW" "$RESET"
    fi
  else
    printf ' %s○%s not installed\n' "$DIM" "$RESET"
  fi

  # 6. Chezmoi health (quick check)
  printf '%s[chezmoi]%s  ' "$CYAN" "$RESET"
  if command -v chezmoi &>/dev/null; then
    local drift
    drift=$(chezmoi diff 2>/dev/null | head -1) || drift=""
    if [[ -z "$drift" ]]; then
      printf '%s✓%s no drift\n' "$GREEN" "$RESET"
    else
      printf '%s!%s drift detected\n' "$YELLOW" "$RESET"
      exit_code=1
    fi
  else
    printf '%s✗%s chezmoi not found\n' "$RED" "$RESET"
    exit_code=1
  fi

  # 7. Telemetry integrity
  printf '%s[telemetry]%s' "$CYAN" "$RESET"
  local telem_dir="${STATE_DIR}/telemetry"
  if [[ -d "$telem_dir" ]]; then
    local telem_files
    telem_files=$(find "$telem_dir" -maxdepth 1 -name '*.jsonl' 2>/dev/null | wc -l | tr -d ' ')
    printf ' %s✓%s %s data file(s)\n' "$GREEN" "$RESET" "$telem_files"
  else
    printf ' %s○%s no telemetry directory\n' "$DIM" "$RESET"
  fi

  echo ""
  if [[ $exit_code -eq 0 ]]; then
    printf '%s%sAll systems healthy%s\n' "$GREEN" "$BOLD" "$RESET"
  else
    printf '%s%sIssues detected%s - review items above\n' "$YELLOW" "$BOLD" "$RESET"
  fi
  echo ""

  return $exit_code
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

main() {
  local cmd="${1:-status}"
  shift 2>/dev/null || true

  case "$cmd" in
    -h | --help | help)
      cmd_help
      ;;
    -v | --version | version)
      cmd_version
      ;;
    status)
      cmd_status "$@"
      ;;
    apply)
      cmd_apply "$@"
      ;;
    sort)
      cmd_sort "$@"
      ;;
    packages | pkg)
      cmd_packages "$@"
      ;;
    perf | performance)
      cmd_perf "$@"
      ;;
    health)
      cmd_health "$@"
      ;;
    doctor | doc)
      cmd_doctor "$@"
      ;;
    *)
      die "Unknown command: $cmd (try 'domus --help')"
      ;;
  esac
}

main "$@"
