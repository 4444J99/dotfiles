# ─────────────────────────────────────────────────────────────────────────────
# Fish Shell Configuration - Managed by Chezmoi
# ─────────────────────────────────────────────────────────────────────────────

if status is-interactive
    # ─────────────────────────────────────────────────────────────────────────
    # Startup Timing (Domus Telemetry)
    # ─────────────────────────────────────────────────────────────────────────

    # Record start time for performance tracking
    set -g _domus_shell_start_ms (perl -MTime::HiRes=time -e 'printf "%d", time * 1000' 2>/dev/null; or echo 0)

    # ─────────────────────────────────────────────────────────────────────────
    # PATH Configuration
    # ─────────────────────────────────────────────────────────────────────────

{{- if eq .chezmoi.os "darwin" }}
{{- if eq .chezmoi.arch "arm64" }}
    # macOS ARM64 (Apple Silicon) - Homebrew
    fish_add_path /opt/homebrew/bin
    fish_add_path /opt/homebrew/sbin
    fish_add_path /opt/homebrew/opt/file-formula/bin
{{- else }}
    # macOS Intel - Homebrew
    fish_add_path /usr/local/bin
    fish_add_path /usr/local/sbin
{{- end }}
{{- else if eq .chezmoi.os "linux" }}
    # Linux Homebrew
    fish_add_path /home/linuxbrew/.linuxbrew/bin
{{- end }}

{{- if eq .chezmoi.os "darwin" }}
    # Ruby (Homebrew - macOS)
    fish_add_path /opt/homebrew/opt/ruby/bin
    fish_add_path /opt/homebrew/lib/ruby/gems/3.4.0/bin
{{- end }}

    # Go
    set -gx GOPATH $HOME/go
    fish_add_path $GOPATH/bin

    # pipx local bin
    fish_add_path $HOME/.local/bin

{{- if eq .chezmoi.os "darwin" }}
    # Toolchains (External Volume - macOS only)
    if test -d /Volumes/4444-iivii/ivi374forivi3ivi3/toolchains/bin
        fish_add_path /Volumes/4444-iivii/ivi374forivi3ivi3/toolchains/bin
    end
{{- end }}

    # ─────────────────────────────────────────────────────────────────────────
    # Environment Variables
    # ─────────────────────────────────────────────────────────────────────────

    set -gx EDITOR nvim
    set -gx VISUAL nvim
    set -gx GEMINI_CLI 1

    # ─────────────────────────────────────────────────────────────────────────
    # 1Password Secrets
    # ─────────────────────────────────────────────────────────────────────────

    # Fish version of secrets loading (if you have a fish-compatible secrets file)
    if test -f $HOME/.config/op/secrets.fish
        source $HOME/.config/op/secrets.fish
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Tool Initializations
    # ─────────────────────────────────────────────────────────────────────────

    # Starship prompt
    if command -q starship
        starship init fish | source
    end

    # Zoxide (smart cd)
    if command -q zoxide
        zoxide init fish | source
    end

    # fzf key bindings
    if command -q fzf
        fzf --fish | source

        # Use fd for fzf if available
        if command -q fd
            set -gx FZF_DEFAULT_COMMAND 'fd --type f --hidden --follow --exclude .git'
            set -gx FZF_CTRL_T_COMMAND $FZF_DEFAULT_COMMAND
            set -gx FZF_ALT_C_COMMAND 'fd --type d --hidden --follow --exclude .git'
        end

        # fzf appearance - Tokyo Night theme
        set -gx FZF_DEFAULT_OPTS '
            --height 40%
            --layout=reverse
            --border=rounded
            --info=inline
            --preview-window=right:50%:wrap
            --color=bg+:#33467c,bg:#1a1b26,spinner:#7dcfff,hl:#7aa2f7
            --color=fg:#c0caf5,header:#7aa2f7,info:#e0af68,pointer:#7dcfff
            --color=marker:#9ece6a,fg+:#c0caf5,prompt:#bb9af7,hl+:#7aa2f7
            --color=border:#3b4261
            --pointer="▶"
            --marker="✓"'

        # Preview files with bat if available
        if command -q bat
            set -gx FZF_CTRL_T_OPTS "--preview 'bat --style=numbers --color=always --line-range :500 {}'"
        end
    end

    # Atuin (shell history)
    if command -q atuin
        atuin init fish | source
    end

    # direnv
    if command -q direnv
        direnv hook fish | source
    end

    # mise (auto-activates in fish per Homebrew)
    if command -q mise
        mise activate fish | source
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Color Theme Tools
    # ─────────────────────────────────────────────────────────────────────────

    # pywal - restore colors on shell startup
    if command -q wal; and test -f $HOME/.cache/wal/sequences
        cat $HOME/.cache/wal/sequences &
        if test -f $HOME/.cache/wal/colors.fish
            source $HOME/.cache/wal/colors.fish
        end
    end

    # lolcat aliases
    if command -q lolcat
        alias lc lolcat
        alias lca 'lolcat -a'
        alias lcf 'lolcat -a -d 2 -s 50'
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Command Help Tools
    # ─────────────────────────────────────────────────────────────────────────

    # navi (interactive cheatsheet) - Ctrl+G
    if command -q navi
        navi widget fish | source
    end

    # tealdeer (tldr client)
    if command -q tldr
        alias tl tldr
        alias tldr-update 'tldr --update'
    end

    # cheat.sh function
    function cht -d "cheat.sh lookup with fzf"
        if test (count $argv) -eq 0
            curl -s "cheat.sh/:list" | fzf \
                --preview 'curl -s "cheat.sh/{}"' \
                --preview-window=right:60%:wrap \
                --header 'cheat.sh - Enter to view' \
                --bind 'enter:execute(curl -s "cheat.sh/{}" | less -R)+abort'
        else
            set -l query (string join '+' $argv)
            curl -s "cheat.sh/$query" | less -R
        end
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Abbreviations (Fish's smart aliases)
    # ─────────────────────────────────────────────────────────────────────────

    # Git
    abbr -a g git
    abbr -a gs 'git status -sb'
    abbr -a gd 'git diff'
    abbr -a gds 'git diff --staged'
    abbr -a ga 'git add'
    abbr -a gaa 'git add -A'
    abbr -a gc 'git commit'
    abbr -a gcm 'git commit -m'
    abbr -a gca 'git commit --amend'
    abbr -a gco 'git checkout'
    abbr -a gcb 'git checkout -b'
    abbr -a gpl 'git pull --rebase'
    abbr -a gps 'git push'
    abbr -a gl 'git log --oneline --graph --decorate -20'
    abbr -a gst 'git stash'
    abbr -a gstp 'git stash pop'
    abbr -a gb 'git branch'

    # Chezmoi
    abbr -a cm chezmoi
    abbr -a cma 'chezmoi apply'
    abbr -a cmd 'chezmoi diff'
    abbr -a cme 'chezmoi edit'
    abbr -a cms 'chezmoi status'

    # Navigation
    abbr -a dl 'cd ~/Downloads'
    abbr -a dt 'cd ~/Desktop'
    abbr -a proj 'cd ~/Projects'

    # Tmux
    abbr -a tm tmux
    abbr -a tma 'tmux attach -t'
    abbr -a tmn 'tmux new -s'
    abbr -a tml 'tmux list-sessions'

    # ─────────────────────────────────────────────────────────────────────────
    # Aliases (for commands that should stay as-is)
    # ─────────────────────────────────────────────────────────────────────────

    # Modern CLI replacements
    if command -q eza
        alias ls 'eza --icons'
        alias ll 'eza -la --icons --git'
        alias la 'eza -a --icons'
        alias lt 'eza --tree --level=2 --icons'
    else
        alias ll 'ls -la'
        alias la 'ls -a'
    end

    if command -q bat
        alias cat 'bat --paging=never'
        alias catp bat
    end

    if command -q rg
        alias grep rg
    end

    # Python
    alias pip pip3

    # Homebrew maintenance
    alias brewup 'brew update && brew upgrade && brew cleanup && brew doctor'

    # Just
    if command -q just
        alias j just
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Domus Aliases
    # ─────────────────────────────────────────────────────────────────────────

    abbr -a dm domus
    abbr -a dms 'domus status'
    abbr -a dma 'domus apply'
    abbr -a dmp 'domus packages'
    abbr -a dmpd 'domus packages diff'

    # Health & recovery
    abbr -a cmh chezmoi-health
    abbr -a cmhv 'VERBOSE=1 chezmoi-health'
    abbr -a cmr chezmoi-recover

    # Lazygit
    if command -q lazygit
        alias lg lazygit
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Kitty Theme Helpers
    # ─────────────────────────────────────────────────────────────────────────

    function kthemes -d "List available kitty themes"
        for f in ~/.config/kitty/themes/*.conf
            basename $f .conf
        end
    end

    function ktheme -d "Switch kitty theme by name"
        if test (count $argv) -eq 0
            echo "Usage: ktheme <theme-name>"
            echo "Available themes:"
            kthemes
            return 1
        end
        if test -f ~/.config/kitty/themes/$argv[1].conf
            kitty @ set-colors ~/.config/kitty/themes/$argv[1].conf
            echo "Applied theme: $argv[1]"
        else
            echo "Theme not found: $argv[1]"
            kthemes
            return 1
        end
    end

    # ─────────────────────────────────────────────────────────────────────────
    # Utility Functions
    # ─────────────────────────────────────────────────────────────────────────

    function myip -d "Show public IP address"
        curl -s https://api.ipify.org; and echo
    end

    function localip -d "Show local IP address"
        ipconfig getifaddr en0
    end

    function cache-sizes -d "Show cache sizes"
        echo "=== Package Manager Caches ==="
        du -sh ~/Library/Caches/Homebrew 2>/dev/null; or true
        du -sh ~/.npm 2>/dev/null; or true
        du -sh ~/Library/Caches/pip 2>/dev/null; or true
        du -sh ~/.cache/uv 2>/dev/null; or true
        echo ""
        echo "=== Browser & App Caches ==="
        du -sh ~/Library/Caches/Google/Chrome 2>/dev/null; or true
        du -sh ~/.cache/puppeteer 2>/dev/null; or true
    end

    function maintain -d "Full system maintenance"
        echo "━━━ System Maintenance - "(date '+%Y-%m-%d %H:%M')" ━━━"
        echo ""
        echo "[1/4] Homebrew..."
        command -q brew; and brew update; and brew upgrade; and brew cleanup; or echo "  Skipped"
        echo ""
        echo "[2/4] npm cache..."
        command -q npm; and npm cache clean --force; or echo "  Skipped"
        echo ""
        echo "[3/4] pip cache..."
        command -q pip3; and pip3 cache purge; or echo "  Skipped"
        echo ""
        echo "[4/4] uv cache..."
        command -q uv; and uv cache prune --force; or echo "  Skipped"
        echo ""
        echo "━━━ Done! ━━━"
    end

    # Shell reload
    alias reload 'source ~/.config/fish/config.fish'

    # ─────────────────────────────────────────────────────────────────────────
    # XDG Compliance
    # ─────────────────────────────────────────────────────────────────────────

    set -gx XDG_CONFIG_HOME $HOME/.config
    set -gx XDG_DATA_HOME $HOME/.local/share
    set -gx XDG_STATE_HOME $HOME/.local/state
    set -gx XDG_CACHE_HOME $HOME/.cache
    set -gx DOCKER_CONFIG $XDG_CONFIG_HOME/docker
    set -gx CARGO_HOME $XDG_DATA_HOME/cargo
    set -gx RUSTUP_HOME $XDG_DATA_HOME/rustup
    set -gx NODE_REPL_HISTORY $XDG_STATE_HOME/node_repl_history
    set -gx LESSHISTFILE $XDG_STATE_HOME/less/history

    # ─────────────────────────────────────────────────────────────────────────
    # Startup Timing - Record (Domus Telemetry)
    # ─────────────────────────────────────────────────────────────────────────

    # Record shell startup time asynchronously
    if test -n "$_domus_shell_start_ms" -a "$_domus_shell_start_ms" != "0"
        fish -c '
            set -l end_ms (perl -MTime::HiRes=time -e "printf \"%d\", time * 1000" 2>/dev/null; or echo 0)
            if test "$end_ms" != "0"
                set -l duration (math "$end_ms - '$_domus_shell_start_ms'")
                set -l telemetry_dir "$HOME/.local/state/domus/telemetry"
                set -l telemetry_file "$telemetry_dir/shell-startup.jsonl"

                # Only record if reasonable (< 30 seconds)
                if test $duration -gt 0 -a $duration -lt 30000
                    mkdir -p "$telemetry_dir"
                    set -l ts (date -u +"%Y-%m-%dT%H:%M:%SZ")
                    echo "{\"timestamp\":\"$ts\",\"ms\":$duration}" >> "$telemetry_file"

                    # Keep file under 100 entries
                    if test -f "$telemetry_file"
                        set -l lines (wc -l < "$telemetry_file" | string trim)
                        if test $lines -gt 100
                            tail -50 "$telemetry_file" > "$telemetry_file.tmp"
                            mv "$telemetry_file.tmp" "$telemetry_file"
                        end
                    end
                end
            end
        ' &
        disown
    end
    set -e _domus_shell_start_ms

end

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
if test -f /opt/anaconda3/bin/conda
    eval /opt/anaconda3/bin/conda "shell.fish" "hook" $argv | source
else
    if test -f "/opt/anaconda3/etc/fish/conf.d/conda.fish"
        . "/opt/anaconda3/etc/fish/conf.d/conda.fish"
    else
        set -x PATH "/opt/anaconda3/bin" $PATH
    end
end
# <<< conda initialize <<<
