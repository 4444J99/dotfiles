#!/usr/bin/env bash
set -euo pipefail

SKILLS_SOURCE="${HOME}/Workspace/a-i--skills"
CLAUDE_SKILLS_PLUGIN="${HOME}/Library/Application Support/Claude/local-agent-mode-sessions/skills-plugin"

if [[ ! -d "$SKILLS_SOURCE" ]]; then
    echo "Skills not synced yet, skipping link"
    exit 0
fi

# Find skills directory or symlink (exclude backups)
SKILLS_TARGET=$(find "$CLAUDE_SKILLS_PLUGIN" -name "skills" ! -name "*.backup*" 2>/dev/null | head -1)

if [[ -n "$SKILLS_TARGET" ]]; then
    # Already correctly linked - silent success
    if [[ -L "$SKILLS_TARGET" && "$(readlink "$SKILLS_TARGET")" == "$SKILLS_SOURCE" ]]; then
        exit 0
    fi

    # Backup if not already a symlink
    if [[ ! -L "$SKILLS_TARGET" ]]; then
        mv "$SKILLS_TARGET" "${SKILLS_TARGET}.backup.$(date +%s)"
        echo "Backed up existing skills directory"
    fi
    ln -sfn "$SKILLS_SOURCE" "$SKILLS_TARGET"
    echo "Linked: $SKILLS_TARGET -> $SKILLS_SOURCE"
else
    echo "Claude Desktop skills directory not found (will link on next run)"
fi
