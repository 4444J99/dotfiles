#!/bin/bash
# Bootstrap script for new machine setup
# Runs when packages.txt changes

set -e

echo "ðŸš€ Installing essential packages..."

{{- if eq .chezmoi.os "darwin" }}
# macOS: Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
  echo "ðŸ“¦ Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  {{- if eq .chezmoi.arch "arm64" }}
  eval "$(/opt/homebrew/bin/brew shellenv)"
  {{- else }}
  eval "$(/usr/local/bin/brew shellenv)"
  {{- end }}
fi

# Install essential packages
echo "ðŸ“¦ Installing essential Homebrew packages..."
brew install \
  git \
  gh \
  1password-cli \
  zsh \
  neovim \
  tmux \
  fzf \
  ripgrep \
  jq \
  node \
  python3 \
  go \
  git-delta \
  lazygit \
  bat \
  lolcat \
  navi \
  tealdeer

# pywal (Python package for image-based color themes)
# Use pipx to avoid PEP 668 externally-managed-environment issues
if ! command -v pipx &>/dev/null; then
  brew install pipx
  pipx ensurepath
fi
pipx install pywal 2>/dev/null || pipx upgrade pywal 2>/dev/null || true

# Initialize tealdeer cache
command -v tldr &>/dev/null && tldr --update || true

# Install optional but recommended (skip if already installed)
echo "ðŸ“¦ Installing recommended packages..."

# Function to check and install a cask
install_cask() {
  local cask="$1"
  local app="$2"
  if [[ -d "/Applications/$app" ]]; then
    echo "  âœ“ $app already installed"
  elif brew list --cask "$cask" &>/dev/null; then
    echo "  âœ“ $cask already installed via Homebrew"
  else
    echo "  Installing $cask..."
    brew install --cask "$cask" || echo "  âš ï¸  Failed to install $cask"
  fi
}

install_cask "1password" "1Password.app"
install_cask "iterm2" "iTerm.app"
install_cask "visual-studio-code" "Visual Studio Code.app"

# Install terminal font
echo "ðŸ“¦ Installing terminal fonts..."
if brew list --cask font-jetbrains-mono-nerd-font &>/dev/null; then
  echo "  âœ“ JetBrains Mono Nerd Font already installed"
else
  echo "  Installing JetBrains Mono Nerd Font..."
  brew install --cask font-jetbrains-mono-nerd-font || echo "  âš ï¸  Failed to install font"
fi

{{- else if eq .chezmoi.os "linux" }}
# Linux: Use apt/yum based on distro
if command -v apt-get &> /dev/null; then
  echo "ðŸ“¦ Using apt-get package manager..."
  sudo apt-get update
  sudo apt-get install -y \
    git \
    zsh \
    neovim \
    tmux \
    fzf \
    ripgrep \
    jq \
    curl \
    wget \
    build-essential \
    python3 \
    python3-pip \
    nodejs \
    npm

  # Install 1Password CLI
  curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
    sudo tee /etc/apt/sources.list.d/1password.list
  sudo apt-get update && sudo apt-get install -y 1password-cli

elif command -v yum &> /dev/null; then
  echo "ðŸ“¦ Using yum package manager..."
  sudo yum install -y \
    git \
    zsh \
    neovim \
    tmux \
    fzf \
    ripgrep \
    jq \
    curl \
    wget \
    gcc \
    make \
    python3 \
    python3-pip \
    nodejs \
    npm
fi

# Install Homebrew on Linux for additional packages
if ! command -v brew &> /dev/null; then
  echo "ðŸ“¦ Installing Homebrew on Linux..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

echo "âœ… Essential packages installed!"
