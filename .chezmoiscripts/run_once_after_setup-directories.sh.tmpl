#!/usr/bin/env bash
# Post-installation setup script
# Creates essential directories and symlinks

set -euo pipefail

echo "üìÅ Setting up directory structure..."

# XDG Base Directories
mkdir -p ~/.config
mkdir -p ~/.local/{bin,share,state}
mkdir -p ~/.cache

# Project directories
mkdir -p ~/Projects/{Active,Archive}
mkdir -p ~/Documents/{Work,Personal,Archive,Notes}

# Context system
mkdir -p ~/.local/share/file-context/{manifests,links}
mkdir -p ~/.local/share/file-context/links/{by-type,by-project,by-year,by-status}
mkdir -p ~/.local/share/file-context/links/by-type/{code,docs,media,data}
mkdir -p ~/.local/share/file-context/links/by-status/{active,archived,reference}

# Domus state directories
mkdir -p ~/.local/state/domus/{telemetry,snapshots}
mkdir -p ~/.config/domus

# SSH
mkdir -p ~/.ssh/sockets
chmod 700 ~/.ssh
[ -d ~/.ssh/sockets ] && chmod 700 ~/.ssh/sockets

# Git hooks directory
mkdir -p ~/.config/git/hooks

echo "‚úÖ Directory structure created"

{{- if eq .chezmoi.os "darwin" }}
# macOS: External drive setup
if [ -d "/Volumes/4444-iivii" ]; then
  echo "üîó Setting up external drive symlinks..."

  # Main External symlink
  if [ ! -e ~/External ]; then
    ln -sf /Volumes/4444-iivii ~/External
    echo "  ‚úÖ ~/External ‚Üí /Volumes/4444-iivii"
  fi

  # Workspace symlink
  if [ -d /Volumes/4444-iivii/ivi374forivi3ivi3/workspace ] && [ ! -e ~/Projects/ivi374 ]; then
    ln -sf /Volumes/4444-iivii/ivi374forivi3ivi3/workspace ~/Projects/ivi374
    echo "  ‚úÖ ~/Projects/ivi374 ‚Üí workspace"
  fi

  # Toolchains symlink
  if [ -d /Volumes/4444-iivii/ivi374forivi3ivi3/toolchains ] && [ ! -e ~/.local/share/toolchains ]; then
    ln -sf /Volumes/4444-iivii/ivi374forivi3ivi3/toolchains ~/.local/share/toolchains
    echo "  ‚úÖ ~/.local/share/toolchains ‚Üí toolchains"
  fi
else
  echo "‚ö†Ô∏è  External drive not connected - symlinks will be created when drive is mounted"
fi
{{- end }}

# Verify essential tools
echo ""
echo "üîç Verifying installation..."

if command -v git &> /dev/null; then
  echo "  ‚úÖ Git: $(git --version)"
else
  echo "  ‚ùå Git not found"
fi

if command -v op &> /dev/null; then
  echo "  ‚úÖ 1Password CLI: $(op --version)"
else
  echo "  ‚ö†Ô∏è  1Password CLI not found"
fi

if command -v zsh &> /dev/null; then
  echo "  ‚úÖ Zsh: $(zsh --version)"
else
  echo "  ‚ùå Zsh not found"
fi

echo ""
echo "Setup complete!"
echo ""
echo "Next steps:"
echo "  1. Sign in to 1Password CLI: op signin"
echo "  2. Reload shell: exec zsh"
echo "  3. Verify aliases work: cms (chezmoi status)"
echo "  4. Check domus status: domus status"
