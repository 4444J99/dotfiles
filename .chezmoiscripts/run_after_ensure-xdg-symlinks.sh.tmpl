#!/usr/bin/env bash
# Ensure XDG symlinks for apps that insist on ~/.<app>
# Idempotent: safe to run on every chezmoi apply
set -euo pipefail

apps=(
  aitk
  anaconda
  antigravity
  bundle
  cagent
  claude-server-commander
  cloudbase-mcp
  codestream
  codex
  conda
  continue
  copilot
  cursor
  docker
  dropbox
  dropbox_bi
  expo
  fx
  gemini
  genkit
  github
  gitkraken
  gk
  gsutil
  jules
  kube
  mcp-auth
  metasystem
  minikube
  my-father-mother
  npm
  ollama
  playwright-mcp
  quokka
  redhat
  semgrep
  serena
  swiftpm
  thumbnails
  titan
  tmux
  tooluniverse
  venvs
  vs-kubernetes
  vscode
  vscode-insiders
  wallaby
)

changed=0

for app in "${apps[@]}"; do
  target="$HOME/.local/share/$app"
  link="$HOME/.$app"

  # Already a correct symlink â€” skip
  if [[ -L "$link" && "$(readlink "$link")" == "$target" ]]; then
    continue
  fi

  # Ensure target directory exists
  mkdir -p "$target"

  # Real directory exists â€” merge contents then remove
  # --ignore-errors: apps like Dropbox have ephemeral internal files
  if [[ -d "$link" && ! -L "$link" ]]; then
    rsync -a --ignore-errors "$link/" "$target/" || true
    rm -rf "$link"
  fi

  # Remove stale symlink or file
  [[ -e "$link" || -L "$link" ]] && rm -f "$link"

  ln -s "$target" "$link"
  ((changed++)) || true
done

if ((changed > 0)); then
  echo "ğŸ”— Created/updated $changed XDG symlinks"
fi
